<!DOCTYPE html>
<html>
  <head>
    <title>VR Tron</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/plivosdk/web/plivo.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">

  </head>
  <body>
  <audio id="audiobgm" loop>
    <source src="nyan.mp3" type="audio/mpeg">
  </audio>
    <div id="welcome-div" class="full-page-div bg">
      <div id = "welcome-page">　
        <div>
          <h2>happy trolling</h2>
          <ul>
            <li class="text-block" id="fullscreen">
            <!--button id="fullscreen"　class = "text-block"-->
            Start Tron
            </li>
          </ul>
        </div>
      </div>
      <div id = "welcome-page-background" class="base-background"></div>
      <div id = "CUHK-logo-background"></div>
    </div>
    <button id="btn-openModalUsername" type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#modal-username" style="display:none">Open Modal</button>
    <div class="modal fade" id="modal-username" role="dialog">
      <div class="modal-dialog">
      <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Please enter your username</h4>
          </div>
          <div class="modal-body">
            <input type="text" id="username">
            <button type="button" class="btn btn-info btn-lg" id="submit-username">Submit</button>
            <button id="btn-closeModalUsername" type="button" class="btn btn-default" data-dismiss="modal" style="display:none">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div id="lobby-div"  class="full-page-div" style="display:none">
      <button id="btn-openModalRoom" type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#modal-roomname" style="display:none">Open Modal</button>
      <div class="modal fade" id="modal-roomname" role="dialog">
        <div class="modal-dialog">
        <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Please enter room name</h4>
            </div>
            <div class="modal-body">
              <input type="text" id="roomname">
              <button type="button" class="btn btn-info btn-lg" id="submit-roomname">Submit</button>
              <button id="btn-closeModalRoom" type="button" class="btn btn-default" data-dismiss="modal" style="display:none">Close</button>
            </div>
          </div>
        </div>
      </div>
      <ul>
        <li class="text-block" id="fullscreen">
          <h3>Room List</h3>
          <span id="btnCreateRoom" class="btn-block">Create Room</span>

        </li>
        <div id="divLobbyRoomList">
        </div>
      </ul>
      <div class="base-background"></div>
    </div>
    <div id="gameroom-div"  class="full-page-div" style="display:none">
      <ul>
        <li class="text-block" id="fullscreen">
          <h3>Game Room</h3>
          <span id="btnLeaveRoom" class="btn-block">Leave Room</span>
        </li>
        <div id="divGameRoomBody">
        </div>
      </ul>
      <div class="base-background"></div>
    </div>
    <div id="game-div" class="full-page-div" style="display:none"></div>

    <script src="3rdparty/socket.io-client/socket.io.js"></script>
    <script src="3rdparty/jquery/dist/jquery.min.js"></script>
    <script src="js/threejs/three.min.js"></script>
    <script src="js/threejs/StereoEffect.js"></script>
    <script src="js/threejs/DeviceOrientationControls.js"></script>
    <script src="js/threejs/OrbitControls.js"></script>
    <script src="js/threejs/ColladaLoader.js"></script>

    <script type="text/javascript">
            function  onMediaPermission (result) {
                if (result) {
                    console.log("get media permission");
                } else {
                    alert("you don't allow media permission, you will can't make a call until you allow it");
                }
            }
      function loginAndDelayMakeCall(usr,pwd){
        Plivo.onMediaPermission = onMediaPermission;
        config = {};
        Plivo.init(config);
        Plivo.conn.login(usr,pwd);
          setTimeout(function() {
            Plivo.conn.call("conference");
            }, 1500);
      }
      var clientList = {};
      function showGameRoom(){
        $("#lobby-div").css("display","none");
        $("#gameroom-div").css("display","block");
      }
      function showLobby(){
        $("#lobby-div").css("display","block");
        $("#gameroom-div").css("display","none");
      }
     function roomJoin(rid){
        console.log(" want join rid:"+rid);
        socket.emit("roomJoin", rid);
      }
      function updateRoomList(data){
        console.log("updateRoomList");
        console.log(data);
        $("#divLobbyRoomList").empty();
        for (var i in data){
          var roomId = i+"";
          var eachRoom = $("<li/>").addClass("text-block");
          eachRoom.append($("<h4/>").html("Room id:"+roomId));
          eachRoom.append($("<h4/>").html("Room name:"+data[i].name));
          eachRoom.append($("<h4/>").html("Num of Players:"+data[i].client_list.length));
          var btnJoin = $("<span/>").html("Join");
          btnJoin.addClass("btn-block");
          btnJoin.on("click",function(){
              var roomToJoin = roomId;
              return function(){
                  roomJoin(roomToJoin);
              }
              }());
          eachRoom.append(btnJoin);
          $("#divLobbyRoomList").append(eachRoom);
        }
      }
      function updateGameRoom(data){
        $("#divGameRoomBody").empty();
        var divInRoomName = $("<div/>").html("Room Name:"+data.name);
        var divInRoomID = $("<div/>").html("Room ID:"+data.room_id);
        var divClientList = $("<div/>");
        for (var i in data.client_list){
          var pid = data.client_list[i];
          var tmpli = $("<div/>").html("client_id:"+pid+":"+clientList[pid].name);
          divClientList.append(tmpli);
        }
        var roomBody = $("<li/>");
        roomBody.addClass("text-block");
        roomBody.append(divInRoomName);
        roomBody.append(divInRoomID);
        roomBody.append(divClientList);
        $("#divGameRoomBody").append(roomBody);
      }
    $("#btnCreateRoom").on('click',function(){

    });
    $("#btnLeaveRoom").click(function(){
        Plivo.conn.hangup();
        socket.emit("roomLeave");
    });
      var socket = io.connect();
    socket.on("roomList",function(data){
            updateRoomList(data);
        });
    socket.on("roomEntered",function(data){
        console.log("roomEntered",data);
        updateGameRoom(data);
        showGameRoom();
        loginAndDelayMakeCall(data['voice'].usr,data['voice'].pwd);
        });
    socket.on("roomLeave",function(data){
        showLobby();
        });
    socket.on("updateClientList",function(data){
        clientList = data;
        console.log(clientList);
        });
    socket.on("disconnect",function(){
        console.log("disconnect");
        //Maybe server down,alert and go to start page
        alert("Disconnect, please make sure server online and connect again");
        $("#lobby-div").css("display","none");
        $("#gameroom-div").css("display","none");
        $("#game-div").css("display","none");
        $("#welcome-div").css("display","block");
        });
    $("#submit-roomname").click(function(){
      $('#btn-closeModalRoom').click();
      var ele = document.getElementById('roomname').value;
      $.ajax({
        'url': 'https://csci4140-trolln.herokuapp.com/api/v1/conference/',
        'type': 'POST',
        'success': function(data) {
        console.log(data);
        console.log("Dont troll");
        var createRoomObj = {};
        createRoomObj['voice'] = data;
        createRoomObj['room_name'] = ele;;
        socket.emit("roomCreate", createRoomObj);
        }
        });    
    });
  </script>
  <script src="js/bundle.js"></script>
</body>
  </html>
